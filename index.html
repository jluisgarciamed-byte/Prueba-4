<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal Participativo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===== VARIABLES CSS ===== */
        :root {
            --primary: #10b981;          /* Color principal verde */
            --primary-dark: #059669;     /* Verde oscuro */
            --primary-light: #34d399;    /* Verde claro */
            --secondary: #3b82f6;        /* Color secundario azul */
            --secondary-dark: #2563eb;   /* Azul oscuro */
            --dark: #1f2937;             /* Fondo oscuro */
            --darker: #111827;           /* Fondo m√°s oscuro */
            --light: #f8fafc;            /* Texto claro */
            --gray: #6b7280;             /* Texto gris */
            --gray-light: #e5e7eb;       /* Bordes grises */
            --success: #10b981;          /* Color √©xito */
            --warning: #f59e0b;          /* Color advertencia */
            --error: #ef4444;            /* Color error */
        }

        /* ===== ESTILOS GENERALES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            line-height: 1.6;
            overflow: hidden;
        }

        /* ===== ENCABEZADO ===== */
        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
            position: relative;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Logo del geoportal */
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo i {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo h1 {
            font-weight: 700;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Barra de b√∫squeda */
        .search-container {
            position: relative;
            width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Resultados de b√∫squeda */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            margin-top: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-result-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
        }

        /* ===== PANEL LATERAL ===== */
        .sidebar {
            width: 400px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* Paneles individuales */
        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .panel:hover {
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
        }

        /* Encabezado de panel */
        .panel-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .panel-header i {
            font-size: 1.1rem;
        }

        .panel-header h3 {
            font-weight: 600;
            font-size: 1rem;
        }

        /* Cuerpo del panel */
        .panel-body {
            padding: 1.5rem;
        }

        /* ===== MAPAS BASE ===== */
        .basemap-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .basemap-item {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        .basemap-item:hover {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.1);
            transform: translateY(-2px);
        }

        .basemap-item.active {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.15);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .basemap-item i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--primary-light);
        }

        .basemap-item.active i {
            color: var(--primary);
        }

        .basemap-item span {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--light);
        }

        /* ===== CAPAS ===== */
        .layers-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .layer-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        .layer-item:hover {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.1);
            transform: translateY(-2px);
        }

        .layer-item.active {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.15);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Icono de capa */
        .layer-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }

        .layer-info {
            flex: 1;
        }

        .layer-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            color: var(--light);
        }

        .layer-type {
            font-size: 0.75rem;
            color: var(--primary-light);
        }

        /* Toggle de capa */
        .layer-toggle {
            width: 48px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .layer-toggle.active {
            background: var(--primary);
        }

        .layer-toggle::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .layer-toggle.active::after {
            transform: translateX(24px);
        }

        /* ===== FORMULARIO DE REPORTES ===== */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: var(--light);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            backdrop-filter: blur(10px);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
            background: rgba(255, 255, 255, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Contenedor de coordenadas */
        .coords-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.25rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .coords-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .coords-display i {
            color: var(--primary);
        }

        #coords-text {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
            color: var(--primary-light);
        }

        .coords-actions {
            margin-bottom: 0.75rem;
        }

        /* Botones */
        .btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .btn-location {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-light);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .btn-location:hover {
            background: rgba(16, 185, 129, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -3px rgba(16, 185, 129, 0.2);
        }

        .btn-map {
            background: rgba(59, 130, 246, 0.1);
            color: var(--secondary);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .btn-map:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -3px rgba(59, 130, 246, 0.2);
        }

        .btn-set {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .btn-set:hover {
            background: rgba(245, 158, 11, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -3px rgba(245, 158, 11, 0.2);
        }

        .btn-send {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            margin-top: 1rem;
            border: none;
            font-weight: 600;
        }

        .btn-send:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -5px rgba(16, 185, 129, 0.4);
        }

        /* Coordenadas manuales */
        .coords-manual {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .coords-manual label {
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            display: block;
            color: var(--light);
        }

        .coords-inputs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .coord-input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            backdrop-filter: blur(10px);
        }

        .coord-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* ===== PANEL DE ESTADO ===== */
        .status-panel {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-top: 1rem;
            backdrop-filter: blur(10px);
        }

        .status-panel.success {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--primary-light);
        }

        .status-panel.error {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--error);
        }

        .status-panel.warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
            color: var(--warning);
        }

        /* ===== CONTENEDOR DEL MAPA ===== */
        .map-container {
            flex: 1;
            position: relative;
        }

        .map {
            height: 100%;
            width: 100%;
        }

        /* ===== LEYENDA DEL MAPA ===== */
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(20px);
            padding: 1.25rem;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 220px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--light);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-title i {
            color: var(--primary);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .legend-color {
            width: 20px;
            height: 12px;
            margin-right: 0.75rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .legend-text {
            font-size: 0.8rem;
            color: var(--light);
        }

        /* ===== INDICADOR DE CARGA ===== */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(20px);
            padding: 2rem 2.5rem;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== CONTROLES DEL MAPA ===== */
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .control-btn {
            width: 48px;
            height: 48px;
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--light);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.4);
            color: var(--primary);
            border-color: var(--primary);
        }

        /* ===== SCROLLBAR PERSONALIZADO ===== */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* ===== ESTILOS PARA REPORTES ===== */
        .report-marker {
            background: none;
            border: none;
        }

        .report-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .report-pendiente { background-color: #f59e0b; }
        .report-en-proceso { background-color: #3b82f6; }
        .report-resuelto { background-color: #10b981; }
    </style>
</head>
<body>
    <!-- ENCABEZADO CON LOGO Y B√öSQUEDA -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-users"></i>
                <h1>Geoportal Participativo</h1>
            </div>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Buscar localidad..." class="search-input">
                <div id="search-results" class="search-results"></div>
            </div>
        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="main-container">
        <!-- PANEL LATERAL IZQUIERDO -->
        <aside class="sidebar">
            <!-- PANEL DE MAPAS BASE -->
            <div class="panel">
                <div class="panel-header">
                    <i class="fas fa-map"></i>
                    <h3>Mapa Base</h3>
                </div>
                <div class="panel-body">
                    <div id="basemaps" class="basemap-grid"></div>
                </div>
            </div>

            <!-- PANEL DE CAPAS -->
            <div class="panel">
                <div class="panel-header">
                    <i class="fas fa-layer-group"></i>
                    <h3>Capas</h3>
                </div>
                <div class="panel-body">
                    <div id="layers" class="layers-container"></div>
                </div>
            </div>

            <!-- PANEL DE REPORTES -->
            <div class="panel">
                <div class="panel-header">
                    <i class="fas fa-comment-medical"></i>
                    <h3>Enviar Reporte</h3>
                </div>
                <div class="panel-body">
                    <div class="report-form">
                        <!-- Formulario para enviar reportes ciudadanos -->
                        <div class="form-group">
                            <label for="nombre">Nombre</label>
                            <input type="text" id="nombre" class="form-input" placeholder="Tu nombre">
                        </div>
                        
                        <div class="form-group">
                            <label for="tipo">Tipo de Requerimiento</label>
                            <select id="tipo" class="form-select">
                                <option value="">Seleccionar...</option>
                                <option value="Agua Potable">Agua Potable</option>
                                <option value="Alcantarillado">Alcantarillado</option>
                                <option value="Alumbrado P√∫blico">Alumbrado P√∫blico</option>
                                <option value="V√≠as">V√≠as</option>
                                <option value="Seguridad">Seguridad</option>
                                <option value="Limpieza">Limpieza</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="comentarios">Comentarios</label>
                            <textarea id="comentarios" class="form-textarea" placeholder="Describe el problema o requerimiento"></textarea>
                        </div>
                        
                        <!-- Selecci√≥n de ubicaci√≥n para el reporte -->
                        <div class="form-group">
                            <label>Ubicaci√≥n del Reporte</label>
                            <div class="coords-container">
                                <div class="coords-display">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span id="coords-text">No seleccionada</span>
                                </div>
                                
                                <div class="coords-actions">
                                    <button type="button" id="get-current-location" class="btn btn-location">
                                        <i class="fas fa-location-arrow"></i>
                                        Mi Ubicaci√≥n
                                    </button>
                                </div>
                                
                                <div class="coords-actions">
                                    <button type="button" id="pick-on-map" class="btn btn-map">
                                        <i class="fas fa-map-pin"></i>
                                        Seleccionar en Mapa
                                    </button>
                                </div>
                                
                                <div class="coords-manual">
                                    <label>Coordenadas Manuales</label>
                                    <div class="coords-inputs">
                                        <input type="number" id="lat-input" placeholder="Latitud" step="any" class="coord-input">
                                    </div>
                                    <div class="coords-inputs">
                                        <input type="number" id="lng-input" placeholder="Longitud" step="any" class="coord-input">
                                    </div>
                                    <div class="coords-inputs">
                                        <button type="button" id="set-manual-coords" class="btn btn-set">
                                            <i class="fas fa-check"></i>
                                            Establecer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bot√≥n para enviar el reporte -->
                        <button type="button" id="report-send" class="btn btn-send">
                            <i class="fas fa-paper-plane"></i>
                            Enviar Reporte
                        </button>
                    </div>
                </div>
            </div>

            <!-- PANEL DE ESTADO DE LA CONEXI√ìN -->
            <div id="status" class="status-panel"></div>
        </aside>

        <!-- CONTENEDOR DEL MAPA PRINCIPAL -->
        <main class="map-container">
            <div id="map" class="map"></div>
            
            <!-- CONTROLES DEL MAPA -->
            <div class="map-controls">
                <button class="control-btn" title="Zoom al alcance total" onclick="zoomToAll()">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="control-btn" title="Limpiar mapa" onclick="limpiarMapa()">
                    <i class="fas fa-broom"></i>
                </button>
                <button class="control-btn" title="Cargar reportes" onclick="cargarReportes()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            
            <!-- LEYENDA DEL MAPA -->
            <div id="legend" class="legend" style="display: none;">
                <div class="legend-title">
                    <i class="fas fa-layer-group"></i>
                    Leyenda
                </div>
                <div id="legend-content"></div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ===== CONFIGURACI√ìN DE SUPABASE =====
        const SUPABASE_URL = 'https://zrjsvoorlsresywgivof.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpyanN2b29ybHNyZXN5d2dpdm9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MTU3NDgsImV4cCI6MjA3NjE5MTc0OH0.rYeKz_6aDvlatFgGYfe6l-Ec757pFdSlsOmFgr-mLmM';

        // ===== VARIABLES GLOBALES =====
        let map;
        let capasCargadas = {};
        let currentBasemap = 'osm';
        let selectedLocation = null;
        let locationMarker = null;
        let isPickingLocation = false;
        let localidadesData = [];
        let reportesLayer = null;
        let reportesCargados = [];

        // ===== INICIALIZACI√ìN DE LA APLICACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            inicializarMapa();
            inicializarBasemaps();
            cargarCapasDisponibles();
            inicializarEventos();
            cargarLocalidades();
            cargarReportes(); // Cargar reportes al iniciar
        });

        // ===== FUNCI√ìN: INICIALIZAR MAPA =====
        function inicializarMapa() {
            map = L.map('map').setView([23.6345, -102.5528], 5);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            L.control.scale({ imperial: false }).addTo(map);
        }

        // ===== FUNCI√ìN: CARGAR REPORTES =====
        async function cargarReportes() {
            try {
                const respuesta = await fetch(`${SUPABASE_URL}/rest/v1/reportes_ciudadanos?select=*`, {
                    headers: { 
                        'apikey': SUPABASE_KEY, 
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!respuesta.ok) throw new Error(`Error ${respuesta.status}: ${respuesta.statusText}`);
                
                const datos = await respuesta.json();
                reportesCargados = datos;
                
                // Crear o actualizar capa de reportes
                if (reportesLayer) {
                    map.removeLayer(reportesLayer);
                }
                
                const features = datos.map(reporte => {
                    let geometria = null;
                    
                    // Intentar usar la geometr√≠a directamente
                    if (reporte.geom) {
                        geometria = postgisToGeoJSON(reporte.geom);
                    }
                    
                    // Si no hay geometr√≠a, crear desde lat/lng
                    if (!geometria && reporte.lat && reporte.lng) {
                        geometria = {
                            type: 'Point',
                            coordinates: [reporte.lng, reporte.lat]
                        };
                    }
                    
                    if (geometria) {
                        return {
                            type: 'Feature',
                            geometry: geometria,
                            properties: reporte
                        };
                    }
                    return null;
                }).filter(feature => feature !== null);
                
                const geoJSONData = {
                    type: 'FeatureCollection',
                    features: features
                };
                
                reportesLayer = L.geoJSON(geoJSONData, {
                    pointToLayer: function(feature, latlng) {
                        // Determinar color seg√∫n estado
                        let estado = feature.properties.estado || 'pendiente';
                        let colorClass = 'report-pendiente';
                        let icono = 'fas fa-exclamation-circle';
                        
                        if (estado === 'en proceso') {
                            colorClass = 'report-en-proceso';
                            icono = 'fas fa-tools';
                        } else if (estado === 'resuelto') {
                            colorClass = 'report-resuelto';
                            icono = 'fas fa-check-circle';
                        }
                        
                        return L.marker(latlng, {
                            icon: L.divIcon({
                                className: 'report-marker',
                                html: `<div class="report-icon ${colorClass}"><i class="${icono}"></i></div>`,
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            })
                        });
                    },
                    onEachFeature: function(feature, layer) {
                        const reporte = feature.properties;
                        let contenidoPopup = `
                            <div style="min-width: 200px;">
                                <strong>${reporte.nombre || 'An√≥nimo'}</strong><br>
                                <small>${new Date(reporte.fecha_creacion).toLocaleDateString()}</small>
                                <hr style="margin: 5px 0;">
                                <strong>Tipo:</strong> ${reporte.tipo_requerimiento}<br>
                                <strong>Estado:</strong> ${reporte.estado || 'pendiente'}<br>
                                <strong>Comentarios:</strong> ${reporte.comentarios || 'Sin comentarios'}
                            </div>
                        `;
                        layer.bindPopup(contenidoPopup);
                    }
                }).addTo(map);
                
                console.log(`‚úÖ ${datos.length} reportes cargados`);
                
            } catch (error) {
                console.error('Error al cargar reportes:', error);
            }
        }

        // ===== FUNCI√ìN: ENVIAR REPORTE =====
        async function enviarReporte() {
            const nombre = document.getElementById('nombre').value.trim();
            const tipo = document.getElementById('tipo').value;
            const comentarios = document.getElementById('comentarios').value.trim();
            
            // Validar campos obligatorios
            if (!nombre || !tipo || !comentarios) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }
            
            if (!selectedLocation) {
                alert('Por favor selecciona una ubicaci√≥n para el reporte');
                return;
            }
            
            try {
                const reporteData = {
                    nombre: nombre,
                    tipo_requerimiento: tipo,
                    comentarios: comentarios,
                    lat: selectedLocation.lat,
                    lng: selectedLocation.lng
                    // La geometr√≠a se genera autom√°ticamente con el trigger
                };
                
                const respuesta = await fetch(`${SUPABASE_URL}/rest/v1/reportes_ciudadanos`, {
                    method: 'POST',
                    headers: { 
                        'apikey': SUPABASE_KEY, 
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(reporteData)
                });
                
                if (!respuesta.ok) {
                    const errorData = await respuesta.json();
                    throw new Error(`Error ${respuesta.status}: ${JSON.stringify(errorData)}`);
                }
                
                const nuevoReporte = await respuesta.json();
                
                alert('‚úÖ Reporte enviado correctamente');
                
                // Limpiar formulario
                document.getElementById('nombre').value = '';
                document.getElementById('tipo').value = '';
                document.getElementById('comentarios').value = '';
                document.getElementById('coords-text').textContent = 'No seleccionada';
                document.getElementById('lat-input').value = '';
                document.getElementById('lng-input').value = '';
                
                // Remover marcador temporal
                if (locationMarker) {
                    map.removeLayer(locationMarker);
                    locationMarker = null;
                }
                
                selectedLocation = null;
                
                // Recargar reportes para mostrar el nuevo
                cargarReportes();
                
            } catch (error) {
                console.error('Error al enviar reporte:', error);
                alert('‚ùå Error al enviar el reporte: ' + error.message);
            }
        }

        // ===== FUNCI√ìN: CARGAR LOCALIDADES PARA B√öSQUEDA =====
        async function cargarLocalidades() {
            try {
                const respuesta = await fetch(`${SUPABASE_URL}/rest/v1/Localidades%201?select=*,geom`, {
                    headers: { 
                        'apikey': SUPABASE_KEY, 
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!respuesta.ok) throw new Error(`Error ${respuesta.status}: ${respuesta.statusText}`);
                
                const datos = await respuesta.json();
                localidadesData = datos;
                
                console.log(`‚úÖ ${localidadesData.length} localidades cargadas para b√∫squeda`);
                
            } catch (error) {
                console.error('Error al cargar localidades:', error);
            }
        }

        // ===== FUNCI√ìN: BUSCAR LOCALIDADES =====
        function buscarLocalidades(termino) {
            const resultadosContainer = document.getElementById('search-results');
            resultadosContainer.innerHTML = '';
            
            if (!termino || termino.length < 2) {
                resultadosContainer.style.display = 'none';
                return;
            }
            
            const terminoLower = termino.toLowerCase();
            const resultados = localidadesData.filter(localidad => {
                return localidad.nom_loc && localidad.nom_loc.toLowerCase().includes(terminoLower);
            }).slice(0, 10);
            
            if (resultados.length === 0) {
                resultadosContainer.style.display = 'none';
                return;
            }
            
            resultados.forEach(localidad => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.textContent = localidad.nom_loc;
                item.onclick = () => {
                    seleccionarLocalidad(localidad);
                    resultadosContainer.style.display = 'none';
                    document.getElementById('search-input').value = localidad.nom_loc;
                };
                resultadosContainer.appendChild(item);
            });
            
            resultadosContainer.style.display = 'block';
        }

        // ===== FUNCI√ìN: SELECCIONAR LOCALIDAD =====
        function seleccionarLocalidad(localidad) {
            const geometria = postgisToGeoJSON(localidad.geom);
            
            if (geometria && geometria.type === 'Point' && geometria.coordinates) {
                const [lng, lat] = geometria.coordinates;
                
                map.setView([lat, lng], 12);
                
                if (locationMarker) {
                    map.removeLayer(locationMarker);
                }
                
                locationMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'location-marker',
                        html: '<i class="fas fa-map-marker-alt" style="color: #3b82f6; font-size: 24px;"></i>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    })
                }).addTo(map);
                
                let contenidoPopup = `<strong>${localidad.nom_loc}</strong>`;
                if (localidad.nom_mun) contenidoPopup += `<br>Municipio: ${localidad.nom_mun}`;
                if (localidad.nom_ent) contenidoPopup += `<br>Entidad: ${localidad.nom_ent}`;
                if (localidad.pobtot) contenidoPopup += `<br>Poblaci√≥n: ${localidad.pobtot}`;
                
                locationMarker.bindPopup(contenidoPopup).openPopup();
                
                establecerUbicacion(lat, lng);
                
            } else {
                alert('No se pudo obtener la ubicaci√≥n de la localidad seleccionada');
            }
        }

        // ===== FUNCI√ìN: ESTABLECER UBICACI√ìN =====
        function establecerUbicacion(lat, lng) {
            selectedLocation = { lat, lng };
            
            document.getElementById('coords-text').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            document.getElementById('lat-input').value = lat;
            document.getElementById('lng-input').value = lng;
            
            // MEJORA: Limpiar marcador anterior si existe
            if (locationMarker) {
                map.removeLayer(locationMarker);
            }
            
            // MEJORA: Crear un marcador m√°s distintivo para la ubicaci√≥n seleccionada
            locationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'selected-location-marker',
                    html: '<i class="fas fa-map-marker-alt" style="color: #ef4444; font-size: 32px; text-shadow: 0 0 8px rgba(255,255,255,0.8);"></i>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32]
                }),
                zIndexOffset: 1000 // Asegurar que est√© por encima de otras capas
            }).addTo(map);
            
            // MEJORA: Abrir popup autom√°ticamente
            locationMarker.bindPopup(`
                <div style="text-align: center;">
                    <strong>Ubicaci√≥n seleccionada</strong><br>
                    Lat: ${lat.toFixed(6)}<br>
                    Lng: ${lng.toFixed(6)}
                </div>
            `).openPopup();
            
            // MEJORA: Centrar el mapa en la ubicaci√≥n seleccionada con un zoom adecuado
            map.setView([lat, lng], Math.max(map.getZoom(), 16));
        }

        // ===== FUNCIONES DE CONVERSI√ìN DE GEOMETR√çA =====
        function postgisToGeoJSON(geom) {
            if (!geom) return null;
            
            try {
                if (typeof geom === 'object') {
                    return geom;
                }
                
                if (typeof geom === 'string') {
                    try {
                        const geoJSON = JSON.parse(geom);
                        if (geoJSON.type && geoJSON.coordinates) {
                            return geoJSON;
                        }
                    } catch (e) {
                        console.log('No es GeoJSON, intentando como WKT...');
                    }
                    
                    if (geom.includes('POLYGON') || geom.includes('LINESTRING') || geom.includes('POINT')) {
                        return wktToGeoJSON(geom);
                    }
                }
                
                console.warn('Formato de geometr√≠a no reconocido:', geom);
                return null;
            } catch (error) {
                console.error('Error convirtiendo geometr√≠a:', error, geom);
                return null;
            }
        }

        function wktToGeoJSON(wkt) {
            try {
                if (wkt.includes('POINT')) {
                    const coordsMatch = wkt.match(/POINT\s*\(\s*([-\d.]+)\s+([-\d.]+)\s*\)/);
                    if (coordsMatch) {
                        const lng = parseFloat(coordsMatch[1]);
                        const lat = parseFloat(coordsMatch[2]);
                        return {
                            type: 'Point',
                            coordinates: [lng, lat]
                        };
                    }
                }
                else if (wkt.includes('MULTIPOLYGON')) {
                    const coordsMatch = wkt.match(/\(\(\(([^)]+)\)\)\)/);
                    if (coordsMatch) {
                        const coords = coordsMatch[1].split(',').map(coord => {
                            const [lng, lat] = coord.trim().split(' ').map(Number);
                            return [lng, lat];
                        });
                        
                        return {
                            type: 'MultiPolygon',
                            coordinates: [[coords]]
                        };
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Error convirtiendo WKT:', error);
                return null;
            }
        }

        // ===== FUNCIONES RESTANTES =====
        function inicializarBasemaps() {
            const basemaps = [
                { id: 'osm', name: 'OpenStreetMap', icon: 'fas fa-globe-americas', active: true },
                { id: 'satellite', name: 'Sat√©lite', icon: 'fas fa-satellite' },
                { id: 'terrain', name: 'Relieve', icon: 'fas fa-mountain' },
                { id: 'dark', name: 'Oscuro', icon: 'fas fa-moon' }
            ];

            const basemapGrid = document.getElementById('basemaps');
            basemapGrid.innerHTML = '';

            basemaps.forEach(basemap => {
                const basemapItem = document.createElement('div');
                basemapItem.className = `basemap-item ${basemap.active ? 'active' : ''}`;
                basemapItem.innerHTML = `
                    <i class="${basemap.icon}"></i>
                    <span>${basemap.name}</span>
                `;
                basemapItem.onclick = () => cambiarBasemap(basemap.id);
                basemapGrid.appendChild(basemapItem);
            });
        }

        function cambiarBasemap(basemapId) {
            map.eachLayer(layer => {
                if (layer instanceof L.TileLayer) {
                    map.removeLayer(layer);
                }
            });

            let newBasemap;
            switch(basemapId) {
                case 'satellite':
                    newBasemap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                    });
                    break;
                case 'terrain':
                    newBasemap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri &mdash; Source: Esri'
                    });
                    break;
                case 'dark':
                    newBasemap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
                    });
                    break;
                default:
                    newBasemap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    });
            }

            newBasemap.addTo(map);
            currentBasemap = basemapId;

            document.querySelectorAll('.basemap-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.basemap-item:nth-child(${['osm', 'satellite', 'terrain', 'dark'].indexOf(basemapId) + 1})`).classList.add('active');

            Object.values(capasCargadas).forEach(capa => {
                capa.addTo(map);
            });
            
            if (reportesLayer) {
                reportesLayer.addTo(map);
            }
        }

        async function cargarCapasDisponibles() {
            const status = document.getElementById('status');
            const layersContainer = document.getElementById('layers');
            
            status.textContent = 'üîç Cargando capas disponibles...';
            status.className = 'status-panel';
            
            try {
                const tablasEspaciales = [
                    'Localidades 1', 
                    'San Francisco_Mun', 
                    'Zonificaci√≥n Primaria_', 
                    'Zonificaci√≥n Secundaria'
                ];
                const capasValidas = [];
                
                for (const tabla of tablasEspaciales) {
                    try {
                        const r = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent(tabla)}?limit=1`, {
                            headers: { 
                                'apikey': SUPABASE_KEY, 
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (r.ok) {
                            capasValidas.push(tabla);
                        }
                    } catch (e) {
                        console.error(`Error al acceder a ${tabla}:`, e);
                    }
                }
                
                if (capasValidas.length === 0) {
                    status.textContent = '‚ùå No se encontraron capas espaciales accesibles.';
                    status.className = 'status-panel error';
                    return;
                }
                
                status.textContent = `‚úÖ ${capasValidas.length} capa(s) disponible(s)`;
                status.className = 'status-panel success';
                
                layersContainer.innerHTML = '';
                capasValidas.forEach(capa => {
                    const tipoGeometria = obtenerTipoGeometria(capa);
                    const color = obtenerColorPorTipo(tipoGeometria);
                    const icono = obtenerIconoPorTipo(tipoGeometria);
                    
                    const layerItem = document.createElement('div');
                    layerItem.className = 'layer-item';
                    layerItem.innerHTML = `
                        <div class="layer-icon" style="background-color: ${color};">
                            <i class="${icono}"></i>
                        </div>
                        <div class="layer-info">
                            <div class="layer-name">${formatearNombre(capa)}</div>
                            <div class="layer-type">${tipoGeometria}</div>
                        </div>
                        <div class="layer-toggle"></div>
                    `;
                    
                    layerItem.onclick = () => toggleCapa(capa);
                    layersContainer.appendChild(layerItem);
                });
                
            } catch (err) {
                status.textContent = '‚ùå Error de conexi√≥n: ' + err.message;
                status.className = 'status-panel error';
                console.error(err);
            }
        }

        function obtenerTipoGeometria(nombreTabla) {
            if (nombreTabla.includes('Localidades')) {
                return 'Punto';
            } else if (nombreTabla.includes('Zonificaci√≥n')) {
                return 'Pol√≠gono';
            } else if (nombreTabla.includes('San Francisco')) {
                return 'Pol√≠gono';
            }
            return 'Desconocido';
        }

        function obtenerColorPorTipo(tipo) {
            switch(tipo) {
                case 'Pol√≠gono': return '#3498db';
                case 'Punto': return '#e74c3c';
                default: return '#95a5a6';
            }
        }

        function obtenerIconoPorTipo(tipo) {
            switch(tipo) {
                case 'Pol√≠gono': return 'fas fa-vector-square';
                case 'Punto': return 'fas fa-map-marker-alt';
                default: return 'fas fa-question';
            }
        }

        function formatearNombre(nombre) {
            return nombre
                .replace(/_/g, ' ')
                .replace(/\s+\d+$/, '')
                .replace(/^\w/, c => c.toUpperCase());
        }

        async function toggleCapa(nombreCapa) {
            const layerItems = document.querySelectorAll('.layer-item');
            let layerItem, toggle;
            
            for (let item of layerItems) {
                if (item.querySelector('.layer-name').textContent === formatearNombre(nombreCapa)) {
                    layerItem = item;
                    toggle = item.querySelector('.layer-toggle');
                    break;
                }
            }
            
            if (!layerItem) return;
            
            if (capasCargadas[nombreCapa]) {
                map.removeLayer(capasCargadas[nombreCapa]);
                delete capasCargadas[nombreCapa];
                toggle.classList.remove('active');
                layerItem.classList.remove('active');
                actualizarLeyenda();
                return;
            }
            
            toggle.classList.add('active');
            layerItem.classList.add('active');
            
            try {
                const respuesta = await fetch(`${SUPABASE_URL}/rest/v1/${encodeURIComponent(nombreCapa)}?select=*`, {
                    headers: { 
                        'apikey': SUPABASE_KEY, 
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!respuesta.ok) throw new Error(`Error ${respuesta.status}: ${respuesta.statusText}`);
                
                const datos = await respuesta.json();
                
                const features = [];
                
                datos.forEach(fila => {
                    const geometria = postgisToGeoJSON(fila.geom);
                    
                    if (geometria) {
                        const propiedades = { ...fila };
                        delete propiedades.geom;
                        
                        features.push({
                            type: 'Feature',
                            geometry: geometria,
                            properties: propiedades
                        });
                    }
                });
                
                if (features.length === 0) {
                    alert(`No se pudieron procesar las geometr√≠as de la capa ${formatearNombre(nombreCapa)}`);
                    toggle.classList.remove('active');
                    layerItem.classList.remove('active');
                    return;
                }
                
                const geoJSONData = {
                    type: 'FeatureCollection',
                    features: features
                };
                
                const tipoGeometria = obtenerTipoGeometria(nombreCapa);
                const color = obtenerColorPorTipo(tipoGeometria);
                
                const pointToLayer = function(feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                };
                
                const style = function(feature) {
                    return {
                        color: color,
                        weight: 2,
                        opacity: 0.8,
                        fillColor: color,
                        fillOpacity: 0.4
                    };
                };
                
                const capa = L.geoJSON(geoJSONData, {
                    pointToLayer: tipoGeometria === 'Punto' ? pointToLayer : undefined,
                    style: tipoGeometria !== 'Punto' ? style : undefined,
                    onEachFeature: function(feature, layer) {
                        let contenidoPopup = `<strong>${formatearNombre(nombreCapa)}</strong><br><hr>`;
                        
                        const propiedadesImportantes = ['nom_loc', 'nom_ent', 'nom_mun', 'pobtot', 'descripcio', 'nomgeo'];
                        
                        propiedadesImportantes.forEach(prop => {
                            if (feature.properties[prop] !== null && 
                                feature.properties[prop] !== undefined) {
                                contenidoPopup += `<strong>${prop}:</strong> ${feature.properties[prop]}<br>`;
                            }
                        });
                        
                        Object.keys(feature.properties).forEach(prop => {
                            if (feature.properties[prop] !== null && 
                                feature.properties[prop] !== undefined &&
                                !propiedadesImportantes.includes(prop) &&
                                prop !== 'geom') {
                                contenidoPopup += `<strong>${prop}:</strong> ${feature.properties[prop]}<br>`;
                            }
                        });
                        
                        layer.bindPopup(contenidoPopup);
                    }
                });
                
                capa.addTo(map);
                capasCargadas[nombreCapa] = capa;
                
                if (Object.keys(capasCargadas).length === 1) {
                    map.fitBounds(capa.getBounds(), { padding: [20, 20] });
                }
                
                actualizarLeyenda();
                
            } catch (error) {
                console.error(`Error al cargar ${nombreCapa}:`, error);
                alert(`Error al cargar la capa ${formatearNombre(nombreCapa)}: ${error.message}`);
                toggle.classList.remove('active');
                layerItem.classList.remove('active');
            }
        }

        function actualizarLeyenda() {
            const leyenda = document.getElementById('legend');
            const leyendaContent = document.getElementById('legend-content');
            const capasActivas = Object.keys(capasCargadas);
            
            if (capasActivas.length === 0) {
                leyenda.style.display = 'none';
                return;
            }
            
            let contenidoLeyenda = '';
            
            capasActivas.forEach(capa => {
                const tipo = obtenerTipoGeometria(capa);
                const color = obtenerColorPorTipo(tipo);
                contenidoLeyenda += `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color:${color}"></div>
                        <div class="legend-text">${formatearNombre(capa)}</div>
                    </div>
                `;
            });
            
            leyendaContent.innerHTML = contenidoLeyenda;
            leyenda.style.display = 'block';
        }

        function zoomToAll() {
            const capasActivas = Object.values(capasCargadas);
            
            if (capasActivas.length === 0) {
                alert('No hay capas cargadas en el mapa');
                return;
            }
            
            const grupo = new L.featureGroup(capasActivas);
            map.fitBounds(grupo.getBounds(), { padding: [20, 20] });
        }

        function limpiarMapa() {
            Object.values(capasCargadas).forEach(capa => {
                map.removeLayer(capa);
            });
            
            capasCargadas = {};
            
            document.querySelectorAll('.layer-item').forEach(item => {
                item.classList.remove('active');
                item.querySelector('.layer-toggle').classList.remove('active');
            });
            
            actualizarLeyenda();
        }

        // ===== FUNCI√ìN MEJORADA: INICIALIZAR EVENTOS =====
        function inicializarEventos() {
            document.getElementById('search-input').addEventListener('input', function(e) {
                buscarLocalidades(e.target.value);
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    document.getElementById('search-results').style.display = 'none';
                }
            });

            document.getElementById('get-current-location').addEventListener('click', function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        establecerUbicacion(lat, lng);
                    }, function(error) {
                        alert('Error al obtener la ubicaci√≥n: ' + error.message);
                    });
                } else {
                    alert('La geolocalizaci√≥n no es soportada por este navegador.');
                }
            });

            // MEJORA: Cambiar el manejo del modo de selecci√≥n en el mapa
            document.getElementById('pick-on-map').addEventListener('click', function() {
                activarSeleccionUbicacion();
            });

            // MEJORA: Cambiar el evento de clic del mapa para manejar mejor la selecci√≥n
            map.on('click', function(e) {
                if (isPickingLocation) {
                    establecerUbicacion(e.latlng.lat, e.latlng.lng);
                    desactivarSeleccionUbicacion();
                }
            });

            // MEJORA: Permitir cancelar la selecci√≥n con la tecla ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && isPickingLocation) {
                    desactivarSeleccionUbicacion();
                }
            });

            // MEJORA: Cambiar el cursor cuando est√© en modo selecci√≥n
            function activarSeleccionUbicacion() {
                isPickingLocation = true;
                map.getContainer().style.cursor = 'crosshair';
                
                // Mostrar mensaje m√°s claro
                mostrarMensajeSeleccion();
                
                // Deshabilitar temporalmente otros controles
                document.getElementById('pick-on-map').disabled = true;
                document.getElementById('pick-on-map').innerHTML = '<i class="fas fa-map-pin"></i> Seleccionando...';
            }

            function desactivarSeleccionUbicacion() {
                isPickingLocation = false;
                map.getContainer().style.cursor = '';
                
                // Restaurar bot√≥n
                document.getElementById('pick-on-map').disabled = false;
                document.getElementById('pick-on-map').innerHTML = '<i class="fas fa-map-pin"></i> Seleccionar en Mapa';
                
                // Ocultar mensaje
                ocultarMensajeSeleccion();
            }

            function mostrarMensajeSeleccion() {
                // Crear o mostrar mensaje de selecci√≥n
                let mensaje = document.getElementById('seleccion-mensaje');
                if (!mensaje) {
                    mensaje = document.createElement('div');
                    mensaje.id = 'seleccion-mensaje';
                    mensaje.style.cssText = `
                        position: absolute;
                        top: 10px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: rgba(31, 41, 55, 0.95);
                        color: white;
                        padding: 10px 20px;
                        border-radius: 8px;
                        z-index: 1000;
                        border: 1px solid var(--primary);
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                        font-size: 14px;
                    `;
                    document.querySelector('.map-container').appendChild(mensaje);
                }
                mensaje.innerHTML = '<i class="fas fa-crosshairs"></i> Haz clic en el mapa para seleccionar ubicaci√≥n (ESC para cancelar)';
                mensaje.style.display = 'block';
            }

            function ocultarMensajeSeleccion() {
                const mensaje = document.getElementById('seleccion-mensaje');
                if (mensaje) {
                    mensaje.style.display = 'none';
                }
            }

            document.getElementById('set-manual-coords').addEventListener('click', function() {
                const lat = parseFloat(document.getElementById('lat-input').value);
                const lng = parseFloat(document.getElementById('lng-input').value);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    establecerUbicacion(lat, lng);
                } else {
                    alert('Por favor ingresa coordenadas v√°lidas');
                }
            });

            document.getElementById('report-send').addEventListener('click', function() {
                enviarReporte();
            });
        }
    </script>
</body>
</html>
